{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}WaziTrade{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'core/styles.css' %}?v=9999">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
     
    <!-- ======= BOOTSTRAP LINKS======= -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body class="{% block body_class %}{% endblock %}">

<!-- ======= BOOTSTRAP TOP NAVBAR (FULLY WORKING) ======= -->

<nav class="navbar navbar-light bg-white mb-2 py-1.7" >    
    <div class="container-fluid">

        <!-- Hamburger that opens sidebar -->
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainMenu" aria-controls="mainMenu" >
            <span class="navbar-toggler-icon"></span>
        </button>

        <a class="navbar-brand mb-3" href="/">WaziTrade</a>

       <form class="d-flex align-items-center w-100" method="get" action="{% url 'core:search' %}">
    <input class="form-control flex-grow-1 me-2 search-input"
           type="search" name="q" placeholder="Search…"
           value="{{ request.GET.q }}">
           
    <button class="btn btn-outline-warning search-btn" type="submit">
        <span class="material-symbols-outlined">search</span>
    </button>
</form>

    </div>
</nav>


<!-- ======= BOOTSTRAP SIDEBAR OFFCANVAS ======= -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mainMenu">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>

    <div class="offcanvas-body">

        <!-- Dynamic categories -->
        <div class="accordion" id="categoriesAccordion">
            {% for cat in all_categories %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ cat.id }}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ cat.id }}">
                        {{ cat.name }}
                    </button>
                </h2>

                <div id="collapse-{{ cat.id }}" class="accordion-collapse collapse"
                     data-bs-parent="#categoriesAccordion">
                    <div class="accordion-body">

                        <a href="{% url 'core:products_by_category' cat.id %}"
                           class="d-block mb-2">All {{ cat.name }}</a>

                        {% for sub in cat.subcategories.all %}
                        <a href="{% url 'core:products_by_subcategory' sub.id %}"
                           class="d-block">{{ sub.name }}</a>
                        {% endfor %}

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <hr>

        <!-- Static sections -->
        <div class="accordion mt-3" id="staticMenu">
            <!-- Deals -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#dealsMenu">
                        Deals
                    </button>
                </h2>
                <div id="dealsMenu" class="accordion-collapse collapse" data-bs-parent="#staticMenu">
                    <div class="accordion-body">
                        <a class="d-block" href="{% url 'core:deals-page' 'today' %}">Today's Deals</a>
                        <a class="d-block" href="{% url 'core:deals-page' 'clearance' %}">Clearance</a>
                        <a class="d-block" href="{% url 'core:deals-page' 'hot' %}">Hot Discounts</a>
                    </div>
                </div>
            </div>

            <!-- New -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#newMenu">
                        New
                    </button>
                </h2>
                <div id="newMenu" class="accordion-collapse collapse" data-bs-parent="#staticMenu">
                    <div class="accordion-body">
                        <a class="d-block" href="/new/">All New</a>
                        <a class="d-block" href="/new/electronics/">Electronics</a>
                        <a class="d-block" href="/new/fashion/">Fashion</a>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <a href="/best-sellers/" class="btn btn-warning w-100 mt-2">Best Sellers</a>

    </div>
</div>


<div class="page-content" style="margin-bottom: 65px;">
    {% block content %}{% endblock %}
</div>

<!-- ======= MOBILE FOOTER NAV ======= -->
{% block mobile_footer %}
<footer class="mobile-footer-floating">
    <a href="/">
        <span class="material-symbols-outlined" style="color: goldenrod;">home</span><br>
        <span>Home</span>
    </a>

    <a href="/contact">
        <span class="material-symbols-outlined" style="color: goldenrod;">call</span><br>
        <span>Contact Us</span>
    </a>

    <a href="{% url 'cart:cart_detail' %}">
        <span class="material-symbols-outlined" style="color: goldenrod;">shopping_cart</span><br>
        <span>Cart</span>
    </a>
    <hr>
    <!-- ⭐ Seller Register -->
    <a href="{% url 'core:seller-register' %}">
        <span class="material-symbols-outlined" style="color: goldenrod;">storefront</span><br>
        <span>Sell With Us</span>
    </a>

    <!-- ⭐ Seller Login -->
    <a href="{% url 'core:seller-login' %}">
        <span class="material-symbols-outlined" style="color:#daa520;">login</span><br>
        <span>Seller Login</span>
    </a>
</footer>
{% endblock %}



<!-- Slide Cart Sidebar -->
<div id="cartSidebar" class="cart-sidebar">
  <div class="cart-header">
    <h3>Your Cart</h3>
    <button id="closeCart" class="close-cart">&times;</button>
  </div>
  <div id="cartItems"></div>
  <div class="cart-footer">
    <p class="subtotal">Subtotal: <span id="cartSubtotal">0</span> UGX</p>
    <a href="{% url 'cart:cart_detail' %}" class="check-btn">Go to Cart</a>
    {% if user.is_authenticated %}
      <a href="{% url 'cart:dpo_pay' %}" class="buy-btn">Proceed to Checkout</a>
    {% else %}
      <a href="{% url 'account_login' %}?next={% url 'cart:dpo_pay' %}" class="buy-btn">Sign in to Checkout</a>
    {% endif %}
  </div>
</div>
<div id="cartOverlay" class="cart-overlay"></div>




<script>
const cartSidebar = document.getElementById("cartSidebar");
const cartOverlay = document.getElementById("cartOverlay");
const closeCart = document.getElementById("closeCart");
const cartBtn = document.getElementById("cartIconBtn");

function openCart() {
    cartSidebar.classList.add("open");
    cartOverlay.classList.add("show");
    loadCartData();
}

function closeCartFunc() {
    cartSidebar.classList.remove("open");
    cartOverlay.classList.remove("show");
}

closeCart.addEventListener("click", closeCartFunc);
cartOverlay.addEventListener("click", closeCartFunc);

if(cartBtn){
    cartBtn.addEventListener("click", e => {
        e.preventDefault();
        openCart();
    });
}

function loadCartData() {
  fetch("/cart/json/")
    .then(res => res.json())
    .then(data => {
        let html = "";
        data.items.forEach(item => {
            html += `
              <div class="cart-item">
                <img src="${item.image}" alt="">
                <div class="item-info">
                  <p>${item.name}</p>
                  <small>UGX: ${item.price}</small><br>
                  <small>Qty: ${item.quantity}</small><br>
                  <span class="remove-btn" onclick="removeFromCart(${item.id})">Remove</span>
                </div>
              </div>
            `;
        });
        document.getElementById("cartItems").innerHTML = html;
        document.getElementById("cartSubtotal").innerText = data.subtotal;
        document.getElementById("cartCount").innerText = data.items.length;
    });
}

function removeFromCart(id) {
  fetch(`/cart/remove/${id}/`)
    .then(() => loadCartData());
}
</script>

<!-- === EXTRA SCRIPTS FROM CHILD TEMPLATES === -->
{% block extra_scripts %}
<script>
// Event delegation for chat trigger (works even if dynamically added)
document.addEventListener("click", function(e) {
    if (e.target.closest(".chat-trigger")) {
        const chatWindow = document.getElementById("chatWindow");
        if(chatWindow){
            chatWindow.style.display = "flex";
        }
    }
    if (e.target.id === "closeChat") {
        const chatWindow = document.getElementById("chatWindow");
        if(chatWindow){
            chatWindow.style.display = "none";
        }
    }
});
</script>

<script>
document.getElementById("searchBtn").addEventListener("click", function () {
    const input = document.getElementById("searchInput");

    // If input is hidden, show it
    if (!input.classList.contains("active")) {
        input.classList.add("active");
        input.focus();
        return; // Don't submit yet
    }

    // If already visible, submit the form
    input.closest("form").submit();
});
</script>


{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
