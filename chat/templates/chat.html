<!-- Floating chat bubble -->
<div class="fixed-chat-bubble" id="chatBubble">
    <span class="material-symbols-outlined">chat</span>
</div>

<!-- Chat window -->
<div class="chat-window" id="chatWindow" style="display:none;">
    <div class="chat-header">
        <h4>Chat with us</h4>
        <button id="closeChat">&times;</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        {% for msg in messages %}
            <div class="chat-msg {% if msg.sender == user %}sent{% else %}received{% endif %}">
                <span>{{ msg.sender.username }}:</span> {{ msg.content }}
            </div>
        {% endfor %}
    </div>
    <form id="chatForm">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <input type="text" id="msgInput" placeholder="Type your message..." autocomplete="off">
        <button type="submit">Send</button>
    </form>
</div>

<!-- CSS -->
<style>
.fixed-chat-bubble {
    position: fixed;
    bottom: 80px;
    right: 30px;
    background: #ff6600;
    color: #fff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index:1000;
}
.chat-window {
    position: fixed;
    bottom: 140px;
    right: 30px;
    width: 300px;
    height: 400px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    z-index:1001;
}
.chat-header { background:#ff6600; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
.chat-messages { flex:1; overflow-y:auto; padding:10px; }
.chat-msg.sent { text-align:right; }
.chat-msg.received { text-align:left; }
#chatForm { display:flex; border-top:1px solid #ddd; }
#chatForm input { flex:1; padding:5px; border:none; }
#chatForm button { padding:5px 10px; border:none; background:#ff6600; color:#fff; cursor:pointer; }
</style>

<!-- JS -->
<script>
const bubble = document.getElementById('chatBubble');
const chatWin = document.getElementById('chatWindow');
const closeBtn = document.getElementById('closeChat');
const chatForm = document.getElementById('chatForm');
const chatMessages = document.getElementById('chatMessages');

bubble.addEventListener('click', () => { chatWin.style.display = 'flex'; });
closeBtn.addEventListener('click', () => { chatWin.style.display = 'none'; });

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const msgInput = document.getElementById('msgInput');
    const content = msgInput.value;
    const sessionId = this.session_id.value;

    if(!content) return;

    fetch("{% url 'chat:send_message' %}", {
        method:'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `session_id=${sessionId}&content=${encodeURIComponent(content)}`
    })
    .then(res => res.json())
    .then(data => {
        const div = document.createElement('div');
        div.className = 'chat-msg sent';
        div.innerHTML = `<span>${data.sender}:</span> ${data.content}`;
        chatMessages.appendChild(div);
        msgInput.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
});
</script>
